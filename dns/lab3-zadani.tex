
\section*{Cíle laboratoře}
\begin{itemize}
  \item Seznámení se systémem a protokolem DNS a s~databází Whois.
  \item Konfigurace a spuštění DNS serveru obsluhujícího vlastní doménu.
\end{itemize}

\section*{Základní instrukce}
\begin{itemize}
  \item Přihlaste se do OS CentOS (F3), user/password: {\tt user}/{\tt user4lab}.
  \item Otevřete si příkazovou řádku pro uživatele {\tt user}.
  \item Otevřete si příkazovou řádku pro uživatele {\tt root} příkazem {\tt su}
    (switch user).
  \item Pro editaci konfiguračních souborů použijte libovolný editor (např.
    nano, vim, gedit).
  \item {\bf Odpovědi na bodované otázky pište do protokolu.}
\end{itemize}

\section*{Úkoly}

\section{Seznámení s~DNS}
\begin{enumerate}
    \item Spusťte program Wireshark (vždy jako \texttt{root} z~příkazové řádky příkazem \texttt{wireshark \&}) a začněte zachytávat DNS komunikaci na rozhraní, pomocí kterého jste připojeni k~Internetu (\texttt{enp2s0}).
    \item Otevřete terminál a pomocí příkazu \texttt{nslookup -type=a vutbr.cz} zjistěte, na jakou IPv4 adresu se překládá doména \texttt{vutbr.cz}. Zjištěnou IPv4 adresu zapište do protokolu ke cvičení. \textbf{(0,25~b.)}
    \item Zachycený DNS dotaz a odpověď si prohlédněte v~programu Wireshark.
    \item Příkazem \texttt{nslookup -type=soa vutbr.cz} si zobrazte SOA záznam naší Alma mater\footnote{\textbf{Alma mater} (latinsky \textbf{matka živitelka}) je původně antické označení pro bohyni matku. Ve středověké poezii se spojení někdy užívalo i pro Pannu Marii jako \emph{Matku Boží} (např. v~hymnu \emph{Alma Redemptoris Mater}). Nejstarší evropská univerzita v~Boloni užívá motto \emph{Alma mater studiorum}. Odtud dnes spojení \textbf{alma mater} metaforicky označuje univerzitu nebo vysokou školu, na které student získal své vzdělání. \emph{Zdroj: Ottův slovník naučný}}.
    \item SOA záznam si dobře prohlédněte (později budete sami vytvářet SOA záznam pro vlastní doménu).
    \item V~programu Wireshark spusťte zachytávání DNS komunikace znovu (dříve zachycený provoz můžete zahodit).
    \item Pomocí příkazu \texttt{nslookup -type=X vutbr.cz} zjistěte autoritativní DNS servery pro doménu \texttt{vutbr.cz} (kde za \texttt{X} doplňte vhodný typ DNS záznamu pro zjištění autoritativních serverů \textbf{(0,25~b.)}). Nenechte se zmást tím, že jste dostali neautoritativní odpověď. Nahlédněte do slidů z~přednášky, abyste si ujasnili pojmy (ne)autoritativní odpověď a autoritativní DNS server pro danou doménu.
    \item Zastavte zachytávání komunikace v~programu Wireshark.
    \item V~zachyceném provozu nalezněte pakety obsahující komunikaci poslední Vámi provedené DNS rezoluce a prozkoumejte je.
    \item Kolik paketů souvisejících s~Vaší DNS rezolucí bylo zachyceno? \textbf{(0,25~b.)}
    \item Byl proveden rekurzivní nebo iterativní DNS dotaz? Podívejte se do \texttt{Flags} v~DNS dotazu a odpovědi. \textbf{(0,25~b.)}
    \item Na jakou IP adresu směřoval paket s~DNS dotazem? Komu náleží tato IP adresa? \textbf{(0,25~b.)} Pokud netušíte, zkuste se podívat do souboru \texttt{/etc/resolv.conf}. V~tomto souboru je uložena IP~adresa lokálně používaného rekurzivního DNS serveru.
    \item Vyzkoušejte zobrazení DNS záznamů pro další libovolné domény (např. \texttt{MX} záznamy pro\\ \texttt{fit.vutbr.cz}~--~všimnněte si priorit u~e-mailových serverů).
\end{enumerate}

\section{Seznámení s~Whois}
\begin{enumerate}
    \item Otevřete ve webovém prohlížeči online nástroj pro prohledávání databáze Whois\\ \url{https://www.nic.cz/whois/}. Tento online nástroj provozuje sdružení~\emph{CZ.NIC}, které je správcem naší národní domény~\texttt{cz.}
    \item Zadejte do vyhledávacího pole doménu \texttt{vutbr.cz}. Prohlédněte si zobrazené informace. Od jakého roku je doména registrována? \textbf{(0,25~b.)}
    \item Zjistěte, jaká je veřejná IP adresa Vašeho počítače - například pomocí webového nástroje\\ \url{https://www.whatismyip.com/}. Následně si v~Terminálu pomocí příkazu \texttt{ip addres show} zobrazte IP adresy na rozhraních Vašeho počítače. Proč ani na jednom rozhranní nevidíte svoji veřejnou IP adresu? (nápověda: NAT)
    \item Na nové kartě webového prohlížeče otevřete nástroj \url{https://whois.domaintools.com} a svoji veřejnou IP adresu zadejte do vyhledávacího pole. Do jakého rozsahu IP adresa patří a kdo má tento rozsah IP adres přidělen? \textbf{(0,25~b.)}
\end{enumerate}

\section{Blokování vybraných domén}
\begin{enumerate}
	\item Do souboru \texttt{/etc/hosts} přidejte následující řádek:\\
    \verb|0.0.0.0    www.facebook.com|
    \item Ve webovém prohlížeči zadejte do adresního řádku \url{www.facebook.com}. Podařilo se Vám stránku zobrazit? Pokud ano, restartujte webový prohlížeč (případně i celý počítač), aby se vymazala mezipaměť DNS, a zkuste znovu.
    \item Přidejte další záznam do souboru \texttt{/etc/hosts} tak, aby při pokusu o~otevření webové stránky \url{httpforever.com} došlo k~otevření webové stránky \url{httpbin.org}. Pozor, v~prvním sloupečku souboru \texttt{/etc/hosts} musí být vždy IP adresa, ne doménové jméno. \textbf{(0,25~b.)}
    \item Zamyslete se nad slabinami tohoto řešení omezení přístupu na webové stránky. Jak lze toto řešení (jednoduše) obejít?
\end{enumerate}

\section{Konfigurace vlastního DNS serveru \textbf{(2~b.)}}
\begin{enumerate}
  \item Prostudujte si začátek kapitoly 9.2.3 z~manuálu k~laboratořím.
  \item Váš budoucí DNS server bude spravovat doménu  {\tt fit.cz}.
  \item Nejdříve upravte konfigurační soubor {\tt /etc/named.conf} následujícím způsobem:
    \begin{itemize}
      \item Do parametru {\tt listen-on} v~sekci {\tt options} přidejte svoji IP adresu na rozhraní {\tt enp2s0}
            (tj.~IP adresu 10.10.10.1XX, kde XX je číslo Vašeho počítače).
            Zajistíte tím, že Váš budoucí DNS server bude přijímat a zpracovávat DNS dotazy, které mu na toto rozhraní ({\tt enp2s0}) přijdou. 
      \item Nastavte {\tt allow-query} na {\tt any;}.
            Tím zajistíte, že kdokoliv (v~lokální síti) bude moci poslat na Váš DNS server dotaz a on ho bude zpracovávat.
            Kdybyste nechali v~nastavení možnost {\tt localhost;}, zpracovával by Váš DNS server dotazy pouze z~Vašeho počítače a
            když by mu zaslal DNS dotaz třeba sousední počítač, zahodil by tento dotaz a neodpověděl by.
      \item Vytvořte dvě nové zóny (téměř na konci souboru před klíčovým slovem {\tt include}). První zónu pro Vaši doménu {\tt fit.cz} a druhou zónu pro reverzní překlad ({\tt 10.10.10.in-addr.arpa}).
            Podívejte se do laboratorního manuálu, jak má vypadat definice nových zón v~souboru {\tt /etc/named.conf}.
            Cesty k~zónovým souborům nastavíte později~--~až po vytvoření těchto souborů.
    \end{itemize}
  
  \item Nyní je potřeba pro nově registrované zóny vytvořit zónové soubory. V~nich používejte \textbf{FQDN}! (Tedy: Doménová jména musí mít na konci tečku.)
  \item Začněte zónovým souborem pro doménu {\tt fit.cz}:
  
    \begin{itemize}
      \item V~souboru {\tt /root/isa3/template.dns.zone} je připravena šablona zónového souboru.\\
            Zkopírujte tento soubor do složky {\tt /var/named} pod novým jménem {\tt db.fit.cz}.
      \item V~nově vytvořeném souboru {\tt /var/named/db.fit.cz} upravte hodnotu TTL na {\tt 3h}.
      \item Upravte SOA záznam domény {\tt fit.cz.} Autoritativní server bude {\tt ns1.fit.cz.}
            Email správce bude {\tt admin.fit.cz.} (nelekněte se, že se v~e-mailové adrese místo znaku '{\tt @}' používá znak '{\tt .}').
      \item Vytvořte NS záznam, který bude ukazovat na autoritativní server {\tt ns1.fit.cz.}
      \item Pro autoritativní server {\tt ns1.fit.cz} vytvořte A~záznam, který bude ukazovat na IP adresu Vašeho počítače (na rozhraní {\tt enp2s0}).
            Uvědomte si, že nyní jste pomocí SOA, NS a A~záznamu nastavili, že Váš počítač je tím autoritativním DNS serverem pro doménu {\tt fit.cz} (tj. Váš počítač spravuje zónový soubor domény).
      \item Přidejte další A~záznam, který bude ukazovat na učitelský počítač v~laboratoři. Záznam zadejte v~tomto tvaru:
            \verb|PCUC    IN    A    10.10.10.1|
      \item Přidejte záznam typu CNAME pro jméno {\tt server} ukazující na {\tt ns1.fit.cz.}
      \item V~případě zájmu nakonfigurujte pro doménu překlad na adresy IPv6 (záznamy AAAA).
    \end{itemize}
    
  \item Tím je zónový soubor pro doménu {\tt fit.cz} připravený. Nyní vytvořte zónový soubor pro reverzní překlad:
  
    \begin{itemize}
      \item Jako šablonu zónového souboru pro reverzní překlad využijte opět soubor\\ {\tt /root/isa3/template.dns.zone}.
            Zkopírujte tento soubor do složky {\tt /var/named} pod novým jménem {\tt db.10.10.10.rev}.
      \item V~nově vytvořeném souboru {\tt /var/named/db.fit.cz} upravte hodnotu TTL na {\tt 3h}.
      \item Upravte SOA záznam domény {\tt 10.10.10.in-addr.arpa.} Autoritativní server bude opět {\tt ns1.fit.cz.}
            Email správce bude také opět {\tt admin.fit.cz.}
      \item Místo všech znaků~{\tt @} používejte celý identifikátor domény {\tt 10.10.10.in-addr.arpa.}
      \item Vytvořte NS záznam, který bude ukazovat na autoritativní server {\tt ns1.fit.cz.}
      \item Přidejte další PTR záznam, který bude ukazovat na učitelský počítač v~laboratoři. Záznam zadejte v~tomto tvaru:
            \verb|1.10.10.10    IN    PTR    PCUC|
      \item V~případě zájmu nakonfigurujte pro doménu překlad z~adres IPv6 (záznamy PTR).
    \end{itemize} 
    
  \item Nezapomeňte nyní zaregistrovat zónové soubory v~souboru {\tt /etc/named.conf} (doplnit cesty k~vytvořeným zónám).
  \item Upravte nastavení firewallu, aby propouštěl DNS dotazy a odpovědi. To provedete příkazy \\{\tt iptables -I INPUT -p udp -m udp --dport 53 -j ACCEPT}\\
        {\tt iptables -I OUTPUT -p udp -m udp --sport 53 -j ACCEPT}

  \item Spusťte DNS server příkazem {\tt systemctl start named.service}.
    Příkazem {\tt systemctl status named} ověřte, zda byla služba správně spuštěna.

  \item Najděte si někoho do dvojice, s~kým si nyní navzájem vyzkoušíte, že Vaše DNS servery jsou správně nakonfigurované.
  \item Oba dva na~svém počítači upravte IP adresu výchozího DNS serveru tímto postupem:
  \begin{itemize}
    \item Na konec souboru {\tt /etc/sysconfig/network-scripts/ifcfg-Wired\char`_connection\char`_1} přidejte následující dva řádky:\\
          \verb|PEERDNS=no|\\
          \verb|DNS1=10.10.10.1YY| , kde {\tt YY} je číslo počítače Vašeho kolegy.
    \item Vypněte a znovu zapněte síťové rozhraní {\tt enp2s0} příkazy: {\tt ifdown enp2s0}; {\tt ifup enp2s0}
    \item Ověřte, že došlo ke změně výchozího DNS serveru v~souboru {\tt /etc/resolv.conf} a že nyní je výchozím DNS serverem počítač Vašeho kolegy.
  \end{itemize}
  \item V~programu Wireshark začněte zachytávat DNS komunikaci na rozhraní {\tt enp2s0}.
  \item V~Terminálu zadejte {\tt ping PCUC.fit.cz}. Došlo k~přeložení doménového jména na IP adresu? Pokud ano, gratuluji! Pokud ne, pomozte Vašemu kolegovi najít chybu
    v~konfiguraci jeho DNS serveru.
  \item Prohlédněte si zachycenou DNS komunikaci ve Wiresharku. Nalezněte DNS dotaz a DNS odpověď provedených při {\tt pingu}.
  \item Otestujte funkčnost dalších DNS záznamů -- například:\\
        {\tt ping server.fit.cz}, {\tt nslookup -type=soa fit.cz}, {\tt dig fit.cz}, {\tt dig fit.cz NS}
  \item {\bf Pochlubte se svými výsledky cvičícímu}.
\end{enumerate}




\section{Ukončení práce v~laboratoři}
\begin{itemize}
  \item Počítač vypněte dávkou {\tt /root/isa3/clean}.
\end{itemize}
